<!--
  ¬°Hola! Este es el archivo todo-en-uno para el juego "Bombi al Rescate".
  Contiene todo el HTML, CSS y JavaScript (React/JSX) necesario para funcionar.
  Puedes subir este √∫nico archivo a GitHub Pages o cualquier otro hosting est√°tico
  y el juego funcionar√° directamente. ¬°No necesitas compilar nada!
-->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>¬°Bombi al Rescate!</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 1. A√±adimos el "traductor" Babel Standalone -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="importmap">
{
  "imports": {
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0"
  }
}
</script>
<style>
  html, body {
    min-height: 100vh;
    overscroll-behavior: none; /* Previene el rebote en mac/ios */
    touch-action: none; /* Deshabilita gestos del navegador para mejorar el juego */
  }
  body {
    background-color: #d0e8f8;
    user-select: none; /* Previene selecci√≥n de texto */
    -webkit-user-select: none;
  }

  @keyframes bob {
    0%, 100% { transform: translateY(-4%); }
    50% { transform: translateY(0); }
  }
  .animate-bob {
    animation: bob 2.5s infinite ease-in-out;
  }

  @keyframes pulse-select {
    0%, 100% { transform: scale(1); filter: brightness(1); }
    50% { transform: scale(1.15); filter: brightness(1.1); }
  }
  .animate-select-pulse {
    animation: pulse-select 0.8s infinite ease-in-out;
    z-index: 50 !important;
  }

  @keyframes pop-in {
    0% { transform: scale(0); opacity: 0; }
    80% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
  }
  .animate-pop-in {
    animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  }

  @keyframes flicker {
    0%, 100% { transform: scale(1, 1) rotate(1deg); opacity: 1; }
    20% { transform: scale(1.1, 0.9) rotate(-2deg) translateY(-5%); opacity: 0.9; }
    40% { transform: scale(0.95, 1.05) rotate(2deg) translateY(0%); opacity: 1; }
    60% { transform: scale(1.05, 0.95) rotate(1deg) translateY(-2%); opacity: 0.85; }
    80% { transform: scale(1, 1) rotate(-1deg) translateY(0); opacity: 1; }
  }
  .animate-flicker {
    animation: flicker 0.9s infinite linear;
  }
  
  @keyframes shake {
    10%, 90% { transform: translate3d(-1px, 0, 0); }
    20%, 80% { transform: translate3d(2px, 0, 0); }
    30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
    40%, 60% { transform: translate3d(4px, 0, 0); }
  }
  .animate-shake {
    animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
  }
  @keyframes tada {
    from { transform: scale3d(1, 1, 1); }
    10%, 20% { transform: scale3d(0.9, 0.9, 0.9) rotate3d(0, 0, 1, -3deg); }
    30%, 50%, 70%, 90% { transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, 3deg); }
    40%, 60%, 80% { transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, -3deg); }
    to { transform: scale3d(1, 1, 1); }
  }
  .animate-tada {
    animation: tada 1s ease-in-out;
  }
  @keyframes medal-pop {
    0% { transform: scale(1); }
    50% { transform: scale(1.6) rotate(15deg); }
    100% { transform: scale(1); }
  }
  .animate-medal-pop {
    animation: medal-pop 0.8s ease-in-out;
  }
  @keyframes confetti-fall {
    0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
    100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
  }
  .confetti-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: hidden;
    z-index: 9999;
  }
  .confetti-piece {
    position: absolute;
    width: 10px;
    height: 10px;
    opacity: 0;
    animation-name: confetti-fall;
    animation-timing-function: linear;
    animation-iteration-count: infinite;
  }
  @keyframes fade-in-scale-up {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }
  .animate-fade-in-scale-up {
    animation: fade-in-scale-up 0.5s ease-out forwards;
  }
  @keyframes fade-in-out-up {
    0% { opacity: 0; transform: translateY(20px) scale(0.9); }
    20%, 80% { opacity: 1; transform: translateY(0) scale(1); }
    100% { opacity: 0; transform: translateY(-20px) scale(0.9); }
  }
  .animate-fade-in-out-up {
    animation: fade-in-out-up 1.5s ease-in-out forwards;
  }
  @keyframes drop {
      0% { transform: scale(1.5) translateY(-20px); opacity: 0; }
      50% { transform: scale(0.9); }
      100% { transform: scale(1) translateY(0); opacity: 1; }
  }
  .animate-drop {
    animation: drop 0.4s ease-out forwards;
  }
  
  /* Estilos para el camino iluminado */
  .path-highlight {
    background-color: rgba(255, 235, 59, 0.7) !important; /* Amarillo m√°s intenso */
    box-shadow: inset 0 0 20px rgba(255, 193, 7, 0.8);
    border-color: #fbbf24 !important;
  }
  
  .count-bubble {
    position: absolute;
    right: -20px; 
    top: 50%;
    transform: translateY(-50%);
    background: #ef4444; /* Red-500 */
    color: white;
    font-weight: 800;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    z-index: 100; /* Ensure it's on top */
    font-size: 1.25rem;
    border: 3px solid white;
  }
  
  @media (min-width: 640px) {
    .count-bubble {
       right: -45px;
       width: 48px;
       height: 48px;
       font-size: 1.5rem;
    }
  }
</style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
  <div id="root"></div>
  <!-- 2. Todo el c√≥digo de la aplicaci√≥n est√° incluido aqu√≠ abajo -->
  <script type="text/babel" data-type="module">
// Import React dependencies
import React, { useState, useEffect, useCallback, useRef } from 'react';
import ReactDOM from 'react-dom/client';

// types.ts
var ItemType;
(function (ItemType) {
    ItemType["BOMBI"] = "BOMBI";
    ItemType["FIRE"] = "FIRE";
})(ItemType || (ItemType = {}));

// components/icons/FireIcon.tsx
// Updated to inline SVG to ensure reliability
const FireIcon = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#f97308" stroke="#ef4444" strokeWidth="1.5" className={className} style={{filter: 'drop-shadow(0 2px 4px rgba(0,0,0,0.2))'}}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M12.884 3.169c.303-.288.512-.675.512-1.119C13.396.758 12.637.002 12.002.002c-.32 0-.622.118-.857.333c-3.663 3.493-4.214 9.445-1.24 13.491c.154.21.35.4.406.553.072.069.15.133.232.189.31.218.685.21 1.002-.002c3.019-2.01 4.196-7.229 1.487-10.407z" />
        <path strokeLinecap="round" strokeLinejoin="round" d="M17.314 7.518c-.822-1.005-1.852-1.83-2.926-2.422c-1.609-.886-3.015-1.118-4.266-.742c-1.017.308-1.883.957-2.412 1.763c-3.147 4.791-.753 11.042 3.652 13.79c.856.534 1.787.83 2.753.83c1.384-.003 2.748-.603 3.75-1.615c4.928-4.979 3.264-12.906-1.551-15.607z" />
    </svg>
);


// components/icons/FirefighterIcon.tsx
// Completely rewritten as inline SVG to guarantee visibility and correct colors
const FirefighterIcon = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" className={className} style={{overflow: 'visible'}}>
    {/* Shadow */}
    <ellipse cx="50" cy="95" rx="30" ry="5" fill="rgba(0,0,0,0.2)" />
    
    {/* Water Spray (Animated) */}
    <path d="M25 60 Q 5 20 15 10" fill="none" stroke="#38bdf8" strokeWidth="8" strokeLinecap="round" className="animate-pulse" style={{transformOrigin: 'bottom center'}} />
    <path d="M25 60 Q 0 30 5 15" fill="none" stroke="#7dd3fc" strokeWidth="5" strokeLinecap="round" strokeDasharray="10 5" />
    <circle cx="5" cy="15" r="3" fill="#e0f2fe" />
    <circle cx="15" cy="10" r="4" fill="#e0f2fe" />

    {/* Body / Coat */}
    <path d="M30 50 Q30 45 50 45 T70 50 L75 90 L25 90 Z" fill="#ef4444" stroke="#7f1d1d" strokeWidth="2" />
    {/* Belt */}
    <rect x="28" y="75" width="44" height="8" fill="#1e293b" />
    <rect x="45" y="74" width="10" height="10" fill="#94a3b8" stroke="#1e293b" />

    {/* Head/Face */}
    <circle cx="50" cy="40" r="14" fill="#fca5a5" />
    <circle cx="46" cy="38" r="1.5" fill="#0f172a" />
    <circle cx="54" cy="38" r="1.5" fill="#0f172a" />
    <path d="M46 45 Q50 48 54 45" fill="none" stroke="#0f172a" strokeWidth="1" />

    {/* Helmet */}
    <path d="M25 35 Q25 15 50 15 T75 35 L80 40 L20 40 Z" fill="#facc15" stroke="#854d0e" strokeWidth="2" />
    <rect x="42" y="20" width="16" height="12" rx="2" fill="#ffffff" stroke="#854d0e" />
    <text x="50" y="29" fontSize="10" textAnchor="middle" fill="#854d0e" fontWeight="bold" fontFamily="sans-serif">B</text>

    {/* Arms holding hose */}
    <path d="M30 55 Q20 60 25 70" fill="none" stroke="#ef4444" strokeWidth="8" strokeLinecap="round"/>
    <path d="M70 55 Q80 60 75 70" fill="none" stroke="#ef4444" strokeWidth="8" strokeLinecap="round"/>
    
    {/* Hose Nozzle */}
    <path d="M25 70 L35 60" fill="none" stroke="#64748b" strokeWidth="6" strokeLinecap="round"/>
    <circle cx="23" cy="72" r="5" fill="#fca5a5" /> {/* Hand */}
    <circle cx="75" cy="70" r="5" fill="#fca5a5" /> {/* Hand */}
    
    {/* Boots */}
    <path d="M35 90 L35 95 L28 95 L28 90" fill="#0f172a" />
    <path d="M65 90 L65 95 L72 95 L72 90" fill="#0f172a" />
  </svg>
);

// components/icons/HomeIcon.tsx
const HomeIcon = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className} aria-hidden="true">
    <path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z" />
    <path d="M12 5.432l8.159 8.159c.026.026.05.054.07.084v6.101a2.25 2.25 0 01-2.25 2.25H6.25a2.25 2.25 0 01-2.25-2.25v-6.101c.02-.03.044-.058.07-.084L12 5.432z" />
  </svg>
);

// components/icons/MedalIcon.tsx
const MedalIcon = ({ className }) => (
  <svg 
    xmlns="http://www.w3.org/2000/svg" 
    viewBox="0 0 24 24" 
    fill="currentColor" 
    className={className}
    aria-hidden="true"
    >
    <path 
        fillRule="evenodd" 
        d="M12.963 2.286a.75.75 0 00-1.071 1.052A9.75 9.75 0 0110.303 6.6a.75.75 0 001.214.882A8.25 8.25 0 0012.963 2.286z" 
        clipRule="evenodd" 
    />
    <path 
        d="M10.875 10.875a.75.75 0 00-1.06 1.06l3.75 3.75a.75.75 0 001.06-1.06l-3.75-3.75z" 
    />
    <path 
        d="M12 1.5a5.25 5.25 0 00-5.25 5.25v3a.75.75 0 00.75.75h9a.75.75 0 00.75-.75v-3A5.25 5.25 0 0012 1.5zm-3.75 5.25a3.75 3.75 0 117.5 0 3.75 3.75 0 01-7.5 0z" 
    />
    <path 
        fillRule="evenodd" 
        d="M12 22.5c-5.161 0-9.539-3.515-10.363-8.25a.75.75 0 011.465-.563A8.98 8.98 0 0012 21a8.98 8.98 0 008.463-7.313a.75.75 0 011.465.563C21.539 18.985 17.161 22.5 12 22.5z" 
        clipRule="evenodd" 
    />
</svg>
);

// components/icons/HeartIcon.tsx
const HeartIcon = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className} aria-hidden="true">
    <path fillRule="evenodd" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" clipRule="evenodd" />
  </svg>
);

// components/LivesIndicator.tsx
const LivesIndicator = ({ lives }) => {
    return (
        <div className="bg-white/70 backdrop-blur-sm p-3 rounded-2xl shadow-md flex items-center gap-2" aria-label={`Vidas restantes: ${lives}`}>
            <span className="font-bold text-slate-700 sr-only">Vidas:</span>
            <div className="flex">
                {[...Array(3)].map((_, i) => (
                    <HeartIcon 
                        key={i} 
                        className={`w-8 h-8 transition-all duration-300 ${i < lives ? 'text-red-500 scale-100' : 'text-slate-300 scale-90 opacity-50'}`} 
                    />
                ))}
            </div>
        </div>
    );
};

// components/GameOverScreen.tsx
const GameOverScreen = ({ score, onRetry, onMenu }) => {
  return (
    <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-fade-in-scale-up">
      <div className="bg-white/95 p-8 rounded-3xl shadow-2xl text-center max-w-md w-full mx-4 border-4 border-red-300">
        <h2 className="text-3xl sm:text-4xl font-bold text-slate-800 mb-2">¬°Juego Terminado!</h2>
        <p className="text-slate-600 text-lg mb-6">Has conseguido {score} rescates.</p>
        <div className="flex flex-col sm:flex-row gap-4">
          <button
            onClick={onRetry}
            className="flex-1 bg-blue-500 text-white font-bold py-3 px-6 rounded-xl text-lg hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-transform transform hover:scale-105"
          >
            Volver a Intentar
          </button>
          <button
            onClick={onMenu}
            className="flex-1 bg-slate-500 text-white font-bold py-3 px-6 rounded-xl text-lg hover:bg-slate-600 focus:outline-none focus:ring-4 focus:ring-slate-300 transition-transform transform hover:scale-105"
          >
            Men√∫ Principal
          </button>
        </div>
      </div>
    </div>
  );
};


// components/InteractiveItem.tsx
const InteractiveItem = ({ type, onClick, justDropped, isTall, isSelected }) => {
  const handleClick = (e) => {
    e.stopPropagation(); 
    e.preventDefault(); // Important: prevents starting a browser drag, allowing our touch move logic to take over
    onClick(type);
  };
  
  const isFire = type === ItemType.FIRE;
  const itemClass = `${isTall ? 'w-12 h-12 sm:w-14 sm:h-14' : 'w-20 h-20 sm:w-24 sm:h-24'} flex items-center justify-center cursor-pointer transition-all duration-200`;
  
  // Animaciones basadas en estado
  let animationClass = isFire ? 'animate-flicker' : 'animate-bob';
  // Important: opacity should not drop when selected, only scale to indicate readiness
  if (isSelected) animationClass = 'animate-select-pulse z-50'; 
  if (justDropped) animationClass = 'animate-drop';

  return (
    <div
      onTouchStart={handleClick}
      onMouseDown={handleClick}
      className={`${itemClass} ${animationClass}`}
      aria-label={isFire ? 'Fuego' : 'Bombero Bombi'}
      style={{ touchAction: 'none' }} 
    >
      {isFire ? (
        <FireIcon className="w-full h-full drop-shadow-md" />
      ) : (
        <FirefighterIcon className="w-full h-full drop-shadow-2xl" />
      )}
    </div>
  );
};

// components/Floor.tsx
const Floor = ({ floorNumber, children, isFireHere, isBombiHere, isTall, stepNumber, isHighlighted }) => {
  
  const windowBaseClass = "w-24 h-full flex items-center justify-center rounded-lg shadow-inner transition-all duration-300 relative";
  const windowNormalClass = "bg-sky-200/60 border-2 border-sky-300/30";
  
  let windowDynamicClass = windowNormalClass;
  
  if (isFireHere) {
    windowDynamicClass = "bg-red-500/80 ring-2 ring-red-600/80";
  } else if (isBombiHere) {
    windowDynamicClass = "bg-cyan-400/80 ring-2 ring-cyan-500/80";
  } else if (isHighlighted) {
    windowDynamicClass = "path-highlight";
  }
  
  const floorHeightClass = isTall ? 'h-12 md:h-14' : 'h-20 md:h-24';

  return (
    <div
      className={`${floorHeightClass} flex items-center justify-center w-full relative`}
      data-floor-number={floorNumber}
      aria-label={`Piso ${floorNumber}`}
    >
      <div className={`${windowBaseClass} ${windowDynamicClass}`}>
        {children}
        {stepNumber > 0 && (
          <div className="count-bubble animate-pop-in">
            {stepNumber}
          </div>
        )}
      </div>
    </div>
  );
};

// components/Building.tsx
const Building = ({ 
    fireFloor, 
    bombiFloor, 
    onItemClick, 
    onSelectionMove, 
    selection, 
    isCelebrating, 
    problem, 
    lastMove, 
    floorCount,
    hoveredFloor 
}) => {
  const isTall = floorCount > 10;
  const floors = Array.from({ length: floorCount }, (_, i) => i);
  const [bombiTop, setBombiTop] = useState(null);
  const containerRef = useRef(null);

  const floorHeight = isTall ? 48 : 80; // Approx pixels
  const itemHeight = isTall ? 40 : 64;
  const verticalOffset = (floorHeight - itemHeight) / 2;
  const topFloorNumber = floorCount - 1;

  // Manejador t√°ctil para el "pathing" (arrastrar el dedo)
  const handleTouchMove = (e) => {
    if (!selection) return;
    const touch = e.touches[0];
    const element = document.elementFromPoint(touch.clientX, touch.clientY);
    // Look for the floor container, works even if we are over the InteractiveItem initially
    const floorDiv = element?.closest('[data-floor-number]');
    
    if (floorDiv) {
      const floorNum = parseInt(floorDiv.getAttribute('data-floor-number'), 10);
      onSelectionMove(floorNum, false); // false = is not final
    }
  };

  const handleTouchEnd = (e) => {
     if (!selection || hoveredFloor === null) return;
     onSelectionMove(hoveredFloor, true); // true = commit move
  };

  // Mouse equivalents for desktop testing
  const handleMouseMove = (e) => {
      if (!selection) return;
      const element = document.elementFromPoint(e.clientX, e.clientY);
      const floorDiv = element?.closest('[data-floor-number]');
      if (floorDiv) {
          const floorNum = parseInt(floorDiv.getAttribute('data-floor-number'), 10);
          onSelectionMove(floorNum, false);
      }
  };

  const handleMouseUp = () => {
      if (selection && hoveredFloor !== null) {
          onSelectionMove(hoveredFloor, true);
      }
  }

  useEffect(() => {
    if (isCelebrating) {
      const startTop = (topFloorNumber - problem.bombi) * floorHeight + verticalOffset;
      setBombiTop(startTop);
      const timer = setTimeout(() => {
        const endTop = (topFloorNumber - problem.fire) * floorHeight + verticalOffset;
        setBombiTop(endTop);
      }, 100);
      return () => clearTimeout(timer);
    } else {
      setBombiTop(null);
    }
  }, [isCelebrating, problem, verticalOffset, floorHeight, topFloorNumber]);

  // Helper para saber si un piso es parte del camino
  const getPathInfo = (floorNum) => {
      if (!selection || hoveredFloor === null) return { step: 0, isPath: false };
      
      const start = selection.floor;
      const end = hoveredFloor;
      
      const min = Math.min(start, end);
      const max = Math.max(start, end);
      
      if (floorNum >= min && floorNum <= max) {
          const step = Math.abs(floorNum - start);
          return { step, isPath: true };
      }
      return { step: 0, isPath: false };
  };

  return (
    <div 
        ref={containerRef}
        className="relative w-56 sm:w-64 bg-gradient-to-b from-slate-600 to-slate-800 p-2 rounded-xl shadow-2xl border-4 border-slate-900 shadow-inner select-none touch-none"
        onTouchMove={handleTouchMove}
        onTouchEnd={handleTouchEnd}
        onMouseMove={handleMouseMove}
        onMouseUp={handleMouseUp}
        onMouseLeave={() => onSelectionMove(null, false)}
    >
      <div className="flex flex-col-reverse">
        {floors.map((floorNum) => {
            const { step, isPath } = getPathInfo(floorNum);
            const isOrigin = selection?.floor === floorNum;
            // Mostramos el n√∫mero SOLO si es parte del camino y no es el origen (Bombi)
            // Esto satisface: "burbujas... solo aparecer en planta que se cruza"
            const showStep = isPath && !isOrigin; 
            
            return (
          <div key={floorNum} className={`relative flex items-center ${isTall ? 'border-b' : 'border-b-2'} border-slate-900/50 last:border-b-0`}>
             <span className={`absolute left-1 top-1/2 -translate-y-1/2 font-bold text-white bg-black/40 rounded-full flex items-center justify-center ${isTall ? 'text-sm w-5 h-5' : 'text-lg w-8 h-8'}`}>
                {floorNum}
             </span>
             <Floor 
                floorNumber={floorNum} 
                isFireHere={fireFloor === floorNum}
                isBombiHere={!isCelebrating && bombiFloor === floorNum}
                isTall={isTall}
                stepNumber={showStep ? step : 0}
                isHighlighted={isPath && !isOrigin}
              >
              <div className={isCelebrating && fireFloor === floorNum ? 'transition-opacity duration-500 delay-1000 opacity-0' : ''}>
                {fireFloor === floorNum && (
                  <InteractiveItem 
                    type={ItemType.FIRE} 
                    onClick={onItemClick} 
                    justDropped={lastMove.type === ItemType.FIRE && lastMove.floor === floorNum} 
                    isTall={isTall} 
                    isSelected={selection?.type === ItemType.FIRE}
                  />
                )}
              </div>
              {!isCelebrating && bombiFloor === floorNum && (
                <InteractiveItem 
                    type={ItemType.BOMBI} 
                    onClick={onItemClick} 
                    justDropped={lastMove.type === ItemType.BOMBI && lastMove.floor === floorNum} 
                    isTall={isTall} 
                    isSelected={selection?.type === ItemType.BOMBI}
                />
              )}
            </Floor>
          </div>
        )})}
      </div>
      {isCelebrating && bombiTop !== null && problem.bombi !== null && problem.fire !== null && (
        <div 
          className={`absolute left-1/2 -translate-x-1/2 z-50 ${isTall ? 'w-12 h-12 sm:w-14 sm:h-14' : 'w-20 h-20 sm:w-24 sm:h-24'}`} 
          style={{ top: `${bombiTop}px`, transition: 'top 1s ease-in-out' }}
        >
          <FirefighterIcon className="w-full h-full animate-bob" />
        </div>
      )}
    </div>
  );
};

// components/Problem.tsx
const Problem = ({
  fireFloor,
  bombiFloor,
  answer,
  setAnswer,
  checkAnswer,
  isCorrect,
  title,
  subtractionType,
}) => {
  const [isShaking, setIsShaking] = useState(false);

  useEffect(() => {
    if (isCorrect === false) {
      setIsShaking(true);
      const timer = setTimeout(() => setIsShaking(false), 820);
      return () => clearTimeout(timer);
    }
  }, [isCorrect]);

  const handleInputChange = (e) => {
    const value = e.target.value.replace(/[^0-9]/g, '');
    setAnswer(value);
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (answer.trim() === '') return;
    checkAnswer();
  };
  
  const isCarryMode = subtractionType === 'carry';
  const minuend = isCarryMode ? fireFloor : Math.max(fireFloor, bombiFloor);
  const subtrahend = isCarryMode ? bombiFloor : Math.min(fireFloor, bombiFloor);

  const inputBaseClasses = "w-16 h-16 text-center bg-white border-2 rounded-lg focus:ring-4 transition text-3xl font-bold";
  const inputNormalClasses = "border-gray-300 focus:ring-blue-300 focus:border-blue-500";
  const inputErrorClasses = "border-red-500 focus:ring-red-300 focus:border-red-500 animate-shake";

  return (
    <div className={`w-full max-w-xs p-4 bg-slate-50/80 backdrop-blur-sm rounded-2xl shadow-lg border transition-all duration-300 animate-fade-in-scale-up ${isCorrect === true ? 'border-green-400 ring-4 ring-green-200' : 'border-white/30'}`}>
      <p className="text-center text-gray-700 text-base md:text-lg mb-2">
        Bombi est√° en el piso <strong className="text-cyan-600">{bombiFloor}</strong> y el fuego en el piso <strong className="text-red-500">{fireFloor}</strong>.
      </p>
      <h2 className="text-center font-bold text-xl md:text-2xl text-gray-800 mb-2">
        {title}
      </h2>
      
      {isCarryMode && minuend >= 10 && isCorrect === false && (
        <div className="my-2 p-2 bg-yellow-100/70 border-l-4 border-yellow-400 text-yellow-800 rounded-r-lg animate-fade-in-scale-up">
          <p className="font-bold text-sm">¬°Pista!</p>
          <p className="text-sm">Del {subtrahend} al {minuend}...</p>
        </div>
      )}

      {isCorrect === true ? (
        <div className="text-center py-6 animate-tada">
            <p className="text-4xl font-bold text-green-600">¬°MUY BIEN!</p>
            <p className="text-green-700 mt-2 text-lg">üéâ ¬°Rescate completado! üéâ</p>
        </div>
      ) : (
        <form onSubmit={handleSubmit} className="mt-4">
          <div className="flex items-center justify-center space-x-2 text-3xl md:text-4xl font-bold mb-4">
            <span className="text-orange-500">{minuend}</span>
            <span className="text-gray-600">-</span>
            <span className="text-red-600">{subtrahend}</span>
            <span className="text-gray-600">=</span>
            <input
              type="number" // Changed to number for better mobile keyboard
              pattern="[0-9]*"
              inputMode="numeric"
              value={answer}
              onChange={handleInputChange}
              className={`${inputBaseClasses} ${isShaking ? inputErrorClasses : inputNormalClasses}`}
              maxLength={2}
              autoFocus
              aria-label="Tu respuesta"
            />
          </div>
          
          <button
            type="submit"
            className="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-xl text-xl hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:scale-100 disabled:cursor-not-allowed shadow-lg active:scale-95"
            disabled={answer.trim() === ''}
          >
            ¬°Comprobar!
          </button>
        </form>
      )}
    </div>
  );
};

// components/Rewards.tsx
const MEDALS = [
  { id: 1, count: 5, label: '5 Rescates', color: 'text-amber-500' },
  { id: 2, count: 10, label: '10 Rescates', color: 'text-slate-400' },
  { id: 3, count: 25, label: '25 Rescates', color: 'text-yellow-500' },
  { id: 4, count: 50, label: '¬°50 Rescates!', color: 'text-cyan-400' },
];

const Rewards = ({ correctAnswersCount, newlyEarnedMedal }) => {
  return (
    <div className="relative bg-white/70 backdrop-blur-sm p-3 rounded-2xl inline-block shadow-md">
       {newlyEarnedMedal && (
        <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-bold text-sm px-4 py-1 rounded-full shadow-lg animate-fade-in-out-up whitespace-nowrap">
          ¬°Medalla Ganada!
        </div>
      )}
      <h3 className="text-base font-semibold text-slate-700 mb-1 sr-only">Tus Medallas</h3>
      <div className="flex justify-center items-end space-x-4 sm:space-x-6">
        {MEDALS.map(medal => {
          const earned = correctAnswersCount >= medal.count;
          const isNewlyEarned = newlyEarnedMedal === medal.count;
          return (
            <div key={medal.id} className="flex flex-col items-center text-center" title={`${medal.label} (${correctAnswersCount}/${medal.count})`}>
              <div className={`relative transition-all duration-500 ${earned ? 'opacity-100 scale-110' : 'opacity-40 grayscale'} ${isNewlyEarned ? 'animate-medal-pop' : ''}`}>
                <MedalIcon className={`w-12 h-12 sm:w-14 sm:h-14 ${medal.color}`} />
              </div>
              <span className={`text-xs mt-1 font-bold ${earned ? 'text-slate-800' : 'text-slate-500'}`}>
                {medal.label}
              </span>
            </div>
          );
        })}
      </div>
    </div>
  );
};

// components/Confetti.tsx
const CONFETTI_COUNT = 80;
const COLORS = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800'];

const Confetti = React.memo(() => {
  const confetti = React.useMemo(() => 
    Array.from({ length: CONFETTI_COUNT }).map((_, i) => {
      const style = {
        left: `${Math.random() * 100}%`,
        animationDuration: `${Math.random() * 3 + 2}s`, // 2s to 5s
        animationDelay: `${Math.random() * 2}s`,
        backgroundColor: COLORS[Math.floor(Math.random() * COLORS.length)],
        transform: `rotate(${Math.random() * 360}deg)`,
      };
      return <div key={i} className="confetti-piece" style={style}></div>;
    }),
  []);

  return <div className="confetti-container">{confetti}</div>;
});

// components/GameModeSelector.tsx
const GameModeSelector = ({ onSelect }) => {
  return (
    <div className="fixed inset-0 bg-sky-300/80 backdrop-blur-md z-50 flex items-center justify-center animate-fade-in-scale-up p-4">
      <div className="bg-white/90 p-6 sm:p-8 rounded-3xl shadow-2xl text-center max-w-4xl w-full">
        <h2 className="text-3xl md:text-4xl font-bold text-slate-800 mb-6">¬øC√≥mo quieres jugar hoy?</h2>
        <div className="flex flex-col md:flex-row gap-4 justify-center items-stretch">
          <button
            onClick={() => onSelect('freePlay')}
            className="flex-1 bg-green-500 text-white font-bold py-8 px-6 rounded-2xl text-xl hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-300 transition-transform transform hover:scale-105 shadow-lg flex flex-col items-center justify-center"
          >
            <span className="text-4xl mb-2">üé®</span>
            Juego Libre
            <p className="font-normal text-base mt-1 opacity-90">Mueve las piezas donde quieras</p>
          </button>
          <button
            onClick={() => onSelect('challenge')}
            className="flex-1 bg-blue-500 text-white font-bold py-8 px-6 rounded-2xl text-xl hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-transform transform hover:scale-105 shadow-lg flex flex-col items-center justify-center"
          >
             <span className="text-4xl mb-2">üèÜ</span>
            Resuelve Retos
            <p className="font-normal text-base mt-1 opacity-90">Resuelve mis restas</p>
          </button>
        </div>
      </div>
    </div>
  );
};

// components/CarryModeSelector.tsx
const CarryModeSelector = ({ onSelect }) => {
  return (
    <div className="fixed inset-0 bg-sky-300/80 backdrop-blur-md z-50 flex items-center justify-center animate-fade-in-scale-up p-4">
      <div className="bg-white/90 p-6 sm:p-8 rounded-3xl shadow-2xl text-center max-w-4xl w-full">
        <h1 className="text-3xl md:text-4xl font-bold text-slate-800 mb-2">¬°Bombi al Rescate!</h1>
        <p className="text-slate-600 mb-6 text-lg">Elige tu nivel:</p>
        <div className="flex flex-col md:flex-row gap-4 justify-center items-stretch">
          <button
            onClick={() => onSelect('simple')}
            className="flex-1 bg-cyan-500 text-white font-bold py-8 px-6 rounded-2xl text-xl hover:bg-cyan-600 focus:outline-none focus:ring-4 focus:ring-cyan-300 transition-transform transform hover:scale-105 shadow-lg flex flex-col items-center justify-center"
          >
            <span className="text-4xl mb-2">üëç</span>
            Restas F√°ciles
            <p className="font-normal text-base mt-1 opacity-90">Sin llevadas</p>
          </button>
          <button
            onClick={() => onSelect('carry')}
            className="flex-1 bg-purple-500 text-white font-bold py-8 px-6 rounded-2xl text-xl hover:bg-purple-600 focus:outline-none focus:ring-4 focus:ring-purple-300 transition-transform transform hover:scale-105 shadow-lg flex flex-col items-center justify-center"
          >
            <span className="text-4xl mb-2">üß†</span>
            Restas de Mayores
            <p className="font-normal text-base mt-1 opacity-90">Con llevadas</p>
          </button>
        </div>
      </div>
    </div>
  );
};

// components/Tutorial.tsx
const Tutorial = ({ gameMode, onClose }) => {
  const isFreePlay = gameMode === 'freePlay';

  const freePlaySteps = [
    { icon: 'üëÜ', text: 'Toca a Bombi o al fuego para seleccionarlos.' },
    { icon: '‚ÜïÔ∏è', text: 'Arrastra tu dedo por las plantas para ver el camino.' },
    { icon: 'üìç', text: 'Suelta el dedo en el piso donde quieras colocarlo.' },
  ];

  const challengeSteps = [
    { icon: 'ü§î', text: 'Mira la resta que te proponemos.' },
    { icon: 'üëÜ', text: 'Toca a Bombi y arrastra el dedo hasta el fuego.' },
    { icon: 'üî¢', text: '¬°Cuenta las burbujas rojas para saber la respuesta!' },
  ];

  const steps = isFreePlay ? freePlaySteps : challengeSteps;
  const title = isFreePlay ? 'üé® Modo Juego Libre' : 'üèÜ Modo Reto';
  const buttonText = isFreePlay ? '¬°A Jugar!' : '¬°Entendido!';

  return (
    <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-fade-in-scale-up">
      <div className="bg-white/95 p-6 sm:p-8 rounded-3xl shadow-2xl text-center max-w-md w-full mx-4 border-4 border-blue-300">
        <h2 className="text-2xl sm:text-3xl font-bold text-slate-800 mb-6">{title}</h2>
        <div className="space-y-4 text-left">
          {steps.map((step, index) => (
            <div key={index} className="flex items-center gap-4 p-3 bg-slate-100 rounded-xl border border-slate-200">
              <span className="text-3xl">{step.icon}</span>
              <p className="text-slate-700 text-lg font-medium">{step.text}</p>
            </div>
          ))}
        </div>
        <button
          onClick={onClose}
          className="mt-8 w-full bg-blue-500 text-white font-bold py-4 px-6 rounded-2xl text-xl hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-transform transform hover:scale-105 shadow-lg"
        >
          {buttonText}
        </button>
      </div>
    </div>
  );
};


// App.tsx
const MEDAL_THRESHOLDS = [5, 10, 25, 50];
const TOP_FLOOR_SIMPLE = 9;
const TOP_FLOOR_CARRY = 19;
const INITIAL_LIVES = 3;

function App() {
  const [subtractionType, setSubtractionType] = useState(null);
  const [gameMode, setGameMode] = useState('selecting');
  const [showTutorial, setShowTutorial] = useState(false);
  
  const [problem, setProblem] = useState({ fire: 5, bombi: 2 });
  const [displayFireFloor, setDisplayFireFloor] = useState(5);
  const [displayBombiFloor, setDisplayBombiFloor] = useState(2);
  
  const [answer, setAnswer] = useState('');
  const [isCorrect, setIsCorrect] = useState(null);
  
  // Nueva l√≥gica de selecci√≥n
  const [selection, setSelection] = useState(null); // { type, floor }
  const [hoveredFloor, setHoveredFloor] = useState(null);

  const [isCelebrating, setIsCelebrating] = useState(false);
  const [newlyEarnedMedal, setNewlyEarnedMedal] = useState(null);
  const [lastMove, setLastMove] = useState({type: null, floor: null});

  const [lives, setLives] = useState(INITIAL_LIVES);
  const [sessionScore, setSessionScore] = useState(0);
  const [isGameOver, setIsGameOver] = useState(false);

  const [correctAnswersCount, setCorrectAnswersCount] = useState(() => {
    const savedCount = localStorage.getItem('correctAnswersCount');
    return savedCount ? JSON.parse(savedCount) : 0;
  });

  const audioCtxRef = useRef(null);

  // Clear the last move animation
  useEffect(() => {
    if (lastMove.type) {
        const timer = setTimeout(() => {
            setLastMove({ type: null, floor: null });
        }, 500);
        return () => clearTimeout(timer);
    }
  }, [lastMove]);
  
  useEffect(() => {
    localStorage.setItem('correctAnswersCount', JSON.stringify(correctAnswersCount));
  }, [correctAnswersCount]);

  const generateNewProblem = useCallback(() => {
    setIsCelebrating(false);
    setAnswer('');
    setIsCorrect(null);

    if (subtractionType === 'carry') {
        let newFireFloor, newBombiFloor;
        do {
            newFireFloor = Math.floor(Math.random() * 10) + 10; // 10 to 19
            newBombiFloor = Math.floor(Math.random() * 10);   // 0 to 9
        } while (newFireFloor % 10 >= newBombiFloor); 
        
        setProblem({ fire: newFireFloor, bombi: newBombiFloor });
        setDisplayFireFloor(newFireFloor);
        setDisplayBombiFloor(newBombiFloor);

    } else { // 'simple' mode
        let newFireFloor, newBombiFloor;
        do {
          newFireFloor = Math.floor(Math.random() * (TOP_FLOOR_SIMPLE + 1));
          newBombiFloor = Math.floor(Math.random() * (TOP_FLOOR_SIMPLE + 1));
        } while (newBombiFloor === newFireFloor);
        
        if (newBombiFloor > newFireFloor) {
          [newBombiFloor, newFireFloor] = [newFireFloor, newBombiFloor];
        }
        
        setProblem({ fire: newFireFloor, bombi: newBombiFloor });
        setDisplayFireFloor(newFireFloor);
        setDisplayBombiFloor(newBombiFloor);
    }
  }, [subtractionType]);

  const playSound = useCallback((type) => {
    if (!audioCtxRef.current) {
      try {
        audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)();
      } catch (e) { return; }
    }
    const audioCtx = audioCtxRef.current;
    if (!audioCtx) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();
    
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
  
    if (type === 'select') {
      // Sonido suave de "burbuja" al seleccionar
      gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
      oscillator.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.1);
      gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.15);
      oscillator.start();
      oscillator.stop(audioCtx.currentTime + 0.15);
    } else if (type === 'move') {
      // Sonido de movimiento
      gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
      oscillator.type = 'triangle';
      oscillator.frequency.setValueAtTime(300, audioCtx.currentTime);
      oscillator.frequency.linearRampToValueAtTime(200, audioCtx.currentTime + 0.1);
      gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.15);
      oscillator.start();
      oscillator.stop(audioCtx.currentTime + 0.15);
    } else if (type === 'climb') {
      gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
      oscillator.type = 'square';
      oscillator.frequency.setValueAtTime(300, audioCtx.currentTime);
      oscillator.frequency.linearRampToValueAtTime(1000, audioCtx.currentTime + 1);
      gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 1.2);
      oscillator.start();
      oscillator.stop(audioCtx.currentTime + 1.2);
    } else if (type === 'correct') {
      gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime);
      oscillator.frequency.linearRampToValueAtTime(783.99, audioCtx.currentTime + 0.1);
      gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.2);
      oscillator.start();
      oscillator.stop(audioCtx.currentTime + 0.2);
    } else if (type === 'medal') {
      const now = audioCtx.currentTime;
      oscillator.type = 'triangle';
      gainNode.gain.setValueAtTime(0.2, now);
      oscillator.frequency.setValueAtTime(523.25, now);
      oscillator.frequency.setValueAtTime(659.25, now + 0.1);
      oscillator.frequency.setValueAtTime(783.99, now + 0.2);
      oscillator.frequency.setValueAtTime(1046.50, now + 0.3);
      gainNode.gain.exponentialRampToValueAtTime(0.00001, now + 0.5);
      oscillator.start();
      oscillator.stop(now + 0.5);
    } else if (type === 'wrong') {
        const now = audioCtx.currentTime;
        oscillator.type = 'sawtooth';
        gainNode.gain.setValueAtTime(0.1, now);
        oscillator.frequency.setValueAtTime(220, now);
        oscillator.frequency.exponentialRampToValueAtTime(110, now + 0.2);
        gainNode.gain.exponentialRampToValueAtTime(0.00001, now + 0.2);
        oscillator.start();
        oscillator.stop(now + 0.2);
    }
  }, []);

  const handleItemClick = (type) => {
    if (isCelebrating || isGameOver) return;
    
    let floor;
    if (type === ItemType.FIRE) floor = displayFireFloor;
    else floor = displayBombiFloor;

    if (selection && selection.type === type) {
        // Deselect if clicking same item
        setSelection(null);
        setHoveredFloor(null);
    } else {
        playSound('select');
        setSelection({ type, floor });
        setHoveredFloor(null); // Reset hover path
    }
  };

  const handleSelectionMove = (targetFloor, isFinal) => {
      if (!selection || isCelebrating || isGameOver) return;

      setHoveredFloor(targetFloor);

      if (isFinal) {
        // Commit the move
        playSound('move');
        setLastMove({ type: selection.type, floor: targetFloor });

        if (gameMode === 'challenge') {
            // En modo reto, solo movemos visualmente, el problema no cambia
            if (selection.type === ItemType.FIRE) setDisplayFireFloor(targetFloor);
            else setDisplayBombiFloor(targetFloor);
        } else {
            // Free Play Mode
            let newFireFloor = displayFireFloor;
            let newBombiFloor = displayBombiFloor;
            
            if (selection.type === ItemType.FIRE) newFireFloor = targetFloor;
            else newBombiFloor = targetFloor;

            setDisplayFireFloor(newFireFloor);
            setDisplayBombiFloor(newBombiFloor);

            // Update logic for freeplay problem gen
            if (newFireFloor !== null && newBombiFloor !== null && newFireFloor !== newBombiFloor) {
                const fire = newFireFloor;
                const bombi = newBombiFloor;
                
                if (subtractionType === 'carry' && (fire < 10 || bombi >= 10 || fire % 10 >= bombi)) {
                    setProblem({ fire: 0, bombi: 0 }); // Invalid state
                } else {
                    setProblem({ fire, bombi });
                }
                setAnswer('');
                setIsCorrect(null);
                setIsCelebrating(false);
            }
        }
        
        setSelection(null);
        setHoveredFloor(null);
      }
  };

  const handleModeSelect = (mode) => {
    setGameMode(mode);
    setSelection(null);
    setShowTutorial(true);
    if (mode === 'challenge') {
      setLives(INITIAL_LIVES);
      setSessionScore(0);
      setIsGameOver(false);
      generateNewProblem();
    } else {
      const initialProblem = subtractionType === 'carry' ? { fire: 12, bombi: 3 } : { fire: 5, bombi: 2 };
      setProblem(initialProblem);
      setDisplayFireFloor(null);
      setDisplayBombiFloor(null);
      setAnswer('');
      setIsCorrect(null);
      setIsCelebrating(false);
    }
  };


  const checkAnswer = () => {
    if (isGameOver) return;
    const minuend = subtractionType === 'carry' ? problem.fire : Math.max(problem.fire, problem.bombi);
    const subtrahend = subtractionType === 'carry' ? problem.bombi : Math.min(problem.fire, problem.bombi);
    const correctAnswer = minuend - subtrahend;

    if (parseInt(answer, 10) === correctAnswer) {
      setIsCorrect(true);
      playSound('correct');
      setIsCelebrating(true);
      
      if (gameMode === 'challenge') {
        playSound('climb');
        setSessionScore(prev => prev + 1);
        const newCount = correctAnswersCount + 1;
        if (MEDAL_THRESHOLDS.includes(newCount)) {
          playSound('medal');
          setNewlyEarnedMedal(newCount);
          setTimeout(() => setNewlyEarnedMedal(null), 1500);
        }
        setCorrectAnswersCount(newCount);
        setTimeout(() => {
          generateNewProblem();
        }, 2500);
      } else {
        playSound('climb');
        setTimeout(() => {
          setIsCelebrating(false);
        }, 2500);
      }
    } else {
      setIsCorrect(false);
      playSound('wrong');
       if (gameMode === 'challenge') {
        const newLives = lives - 1;
        setLives(newLives);
        if (newLives <= 0) {
            setTimeout(() => setIsGameOver(true), 500);
        }
       }
    }
  };

  const restartChallenge = () => {
    setIsGameOver(false);
    setLives(INITIAL_LIVES);
    setSessionScore(0);
    generateNewProblem();
  };

  const setAnswerWrapper = (value) => {
    if (isCorrect !== null) setIsCorrect(null);
    setAnswer(value);
  }
  
  const getFooterText = () => {
    if (isGameOver) return '¬°El reto ha terminado!';
    if (selection) {
      return 'Arrastra tu dedo hasta el piso donde quieras ir.';
    }
    if (gameMode === 'freePlay') {
        if (displayFireFloor === null || displayBombiFloor === null) {
            return 'Toca una pieza para cogerla.';
        }
        return '¬°Mueve a Bombi y al fuego para crear nuevas restas!';
    }
    return 'Usa a Bombi para contar la distancia.';
  };
  
  if (!subtractionType) return <CarryModeSelector onSelect={setSubtractionType} />;
  if (gameMode === 'selecting') return <GameModeSelector onSelect={handleModeSelect} />;
  
  const isCarryMode = subtractionType === 'carry';
  const isTallBuilding = isCarryMode;

  return (
    <div className="min-h-screen w-full flex flex-col items-center justify-center p-2 sm:p-4 font-sans bg-transparent overflow-hidden relative">
      {isGameOver && <GameOverScreen score={sessionScore} onRetry={restartChallenge} onMenu={() => { setGameMode('selecting'); setSubtractionType(null); setIsGameOver(false); }} />}
      {showTutorial && <Tutorial gameMode={gameMode} onClose={() => setShowTutorial(false)} />}
      
      <button
        onClick={() => { setGameMode('selecting'); setSubtractionType(null); }}
        className="absolute top-2 left-2 z-30 bg-white/80 backdrop-blur-sm p-2 rounded-full shadow-md hover:bg-white transition-transform hover:scale-105 flex items-center gap-2 text-slate-700 font-semibold"
        aria-label="Volver al men√∫ principal"
      >
        <HomeIcon className="w-6 h-6" />
      </button>

      {isCelebrating && <Confetti />}
      
      {isCelebrating && (
        <div className="absolute top-20 left-1/2 -translate-x-1/2 z-40 text-center pointer-events-none w-full px-4">
          <h2 
            className="text-5xl sm:text-6xl font-bold text-white bg-gradient-to-r from-green-400 via-cyan-400 to-blue-500 p-4 rounded-3xl shadow-2xl animate-fade-in-out-up border-4 border-white"
            aria-live="polite"
          >
            ¬°Bien Hecho!
          </h2>
        </div>
      )}

      <header className="text-center mb-2 z-10 pt-8 sm:pt-0">
        <h1 className="text-2xl sm:text-4xl font-bold text-slate-800 drop-shadow-lg">
          ¬°Bombi al Rescate!
        </h1>
      </header>
      
      <main className="flex flex-col items-center justify-center gap-4 w-full z-10 flex-grow">
        <div className="flex justify-center items-center gap-4 flex-wrap min-h-[60px]">
          {gameMode === 'challenge' && <Rewards correctAnswersCount={correctAnswersCount} newlyEarnedMedal={newlyEarnedMedal} />}
          {gameMode === 'challenge' && <LivesIndicator lives={lives} />}
        </div>
        
        <div className="flex flex-col lg:flex-row items-center lg:items-start justify-center gap-4 lg:gap-12 w-full max-w-5xl">
          {/* Building Column */}
          <div className="flex-shrink-0">
             <Building 
                fireFloor={displayFireFloor} 
                bombiFloor={displayBombiFloor} 
                onItemClick={handleItemClick}
                onSelectionMove={handleSelectionMove}
                selection={selection}
                hoveredFloor={hoveredFloor}
                isCelebrating={isCelebrating}
                problem={problem}
                lastMove={lastMove}
                floorCount={isCarryMode ? TOP_FLOOR_CARRY + 1 : TOP_FLOOR_SIMPLE + 1}
              />
          </div>

          {/* Controls Column */}
          <div className="flex flex-col items-center gap-4 w-full max-w-sm">
            {gameMode === 'challenge' && (
              <Problem 
                key={`${problem.fire}-${problem.bombi}`}
                fireFloor={problem.fire}
                bombiFloor={problem.bombi}
                answer={answer}
                setAnswer={setAnswerWrapper}
                checkAnswer={checkAnswer}
                isCorrect={isCorrect}
                title="¬øCu√°ntos pisos hay de diferencia?"
                subtractionType={subtractionType}
              />
            )}
            {gameMode === 'freePlay' && (
              <>
                {(displayFireFloor !== null && displayBombiFloor !== null) ? (
                  <Problem
                    key={`${problem.fire}-${problem.bombi}-freeplay`}
                    fireFloor={problem.fire}
                    bombiFloor={problem.bombi}
                    answer={answer}
                    setAnswer={setAnswerWrapper}
                    checkAnswer={checkAnswer}
                    isCorrect={isCorrect}
                    title="¬°Resuelve la resta!"
                    subtractionType={subtractionType}
                  />
                ) : (
                  <div className="w-full p-6 bg-slate-50/80 backdrop-blur-sm rounded-3xl shadow-lg border-white/30 text-center flex items-center justify-center h-40">
                      <p className="text-slate-600 font-semibold text-xl animate-pulse">Coloca a Bombi y al fuego.</p>
                  </div>
                )}
                
                <div className="p-4 bg-white/60 backdrop-blur-sm rounded-3xl shadow-lg border border-white flex flex-col items-center justify-center gap-2 w-full">
                    {(displayBombiFloor === null || displayFireFloor === null) && (
                         <p className="font-bold text-slate-700 mb-2">Tus piezas:</p>
                    )}
                    <div className="flex gap-8">
                        {displayBombiFloor === null && selection?.type !== ItemType.BOMBI && (
                            <InteractiveItem type={ItemType.BOMBI} onClick={handleItemClick} isTall={isTallBuilding} isSelected={selection?.type === ItemType.BOMBI} />
                        )}
                        {displayFireFloor === null && selection?.type !== ItemType.FIRE && (
                            <InteractiveItem type={ItemType.FIRE} onClick={handleItemClick} isTall={isTallBuilding} isSelected={selection?.type === ItemType.FIRE} />
                        )}
                    </div>
                </div>
              </>
            )}
          </div>
        </div>
      </main>
      <footer className="mt-2 pb-2 text-center text-slate-700 font-semibold drop-shadow-md z-10 text-sm sm:text-base">
        <p>{getFooterText()}</p>
      </footer>
    </div>
  );
}

// index.tsx
const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>