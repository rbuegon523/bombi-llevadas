<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Operaci√≥n Rescate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brick-red': '#C0392B',
                        'fire-orange': '#E67E22',
                        'sky-blue': '#87CEEB',
                        'grass-green': '#2ECC71',
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif; user-select: none; -webkit-user-select: none; touch-action: manipulation; }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .digit-input {
            caret-color: transparent;
        }
        /* Prevent pull-to-refresh on mobile */
        body {
            overscroll-behavior-y: contain;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-sky-blue h-screen w-screen overflow-hidden text-gray-800">
    <div id="app" class="h-full w-full"></div>

    <script>
        // AUDIO SYSTEM
        const AudioController = {
            ctx: null,
            init: function() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
            },
            playTone: function(freq, type, duration, time = 0, vol = 0.1) {
                if (!this.ctx) this.init();
                if (this.ctx.state === 'suspended') this.ctx.resume();
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime + time);
                
                gain.gain.setValueAtTime(vol, this.ctx.currentTime + time);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + time + duration);
                
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                
                osc.start(this.ctx.currentTime + time);
                osc.stop(this.ctx.currentTime + time + duration);
            },
            playVictory: function() {
                // Happy arpeggio
                this.playTone(523.25, 'triangle', 0.2, 0, 0.2); // C5
                this.playTone(659.25, 'triangle', 0.2, 0.15, 0.2); // E5
                this.playTone(783.99, 'triangle', 0.2, 0.3, 0.2); // G5
                this.playTone(1046.50, 'sine', 0.6, 0.45, 0.3); // C6
            },
            playStep: function() {
                // Short pop
                this.playTone(400, 'sine', 0.1, 0, 0.1);
            },
            playError: function() {
                // Low buzz
                this.playTone(150, 'sawtooth', 0.3, 0, 0.1);
            },
            playClick: function() {
                this.playTone(800, 'sine', 0.05, 0, 0.05);
            }
        };

        // ICONS (SVG Strings)
        const Icons = {
            Home: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
            Refresh: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>`,
            Flame: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-500"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3.7 1.8 1.8 2.6 2.9 2.8z"/></svg>`,
            Cloud: `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" class="text-white/60"><path d="M17.5 19c0-1.7-1.3-3-3-3h-11a4 4 0 1 1 .9-7.9 4 4 0 0 1 7.5-2.1 5 5 0 0 1 9.2 3.8 3 3 0 0 1 2.4 5.2"/></svg>`,
            ArrowUp: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>`,
            Delete: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/><line x1="18" y1="9" x2="12" y2="15"/><line x1="12" y1="9" x2="18" y2="15"/></svg>`,
            Check: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`,
            Trash: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>`
        };

        // GAME STATE
        const State = {
            screen: 'MENU', // MENU, GAME
            gameMode: 'SIN_LLEVADAS', // SIN_LLEVADAS, CON_LLEVADAS
            inputMode: 'RESOLVER', // RESOLVER, CREAR
            minuend: '',
            subtrahend: '',
            result: '',
            activeInput: null, // 'minuend', 'subtrahend', 'result'
            bombiFloor: 0,
            steps: 0,
            message: '',
            victory: false,
            isDragging: false
        };

        // UTILS
        function randomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function generateProblem() {
            let m, s;
            // Keep numbers smaller to fit building on screen nicely (max ~20 floors)
            const maxVal = 20; 
            
            if (State.gameMode === 'SIN_LLEVADAS') {
                 // STRICT: Fire never above floor 9
                 m = randomInt(1, 9);
                 s = randomInt(0, m - 1);
            } else {
                 // With carry
                 // Limit minuend to maxVal (20) for better visualization on single screen
                 let ok = false;
                 let attempts = 0;
                 while(!ok && attempts < 50) {
                    m = randomInt(11, maxVal); 
                    s = randomInt(2, m - 1);
                    if (m % 10 < s % 10) ok = true;
                    attempts++;
                 }
                 if (!ok) { m = 12; s = 5; } // Fallback
            }
            return { m: m.toString(), s: s.toString() };
        }

        function initGame(gMode, iMode) {
            AudioController.playClick();
            State.gameMode = gMode;
            State.inputMode = iMode;
            State.screen = 'GAME';
            State.victory = false;
            State.message = '';
            State.result = '';
            State.steps = 0;

            if (iMode === 'RESOLVER') {
                const p = generateProblem();
                State.minuend = p.m;
                State.subtrahend = p.s;
                State.bombiFloor = parseInt(p.s);
                State.activeInput = 'result';
            } else {
                State.minuend = '';
                State.subtrahend = '';
                State.bombiFloor = 0;
                State.activeInput = 'minuend';
            }
            render();
        }

        // ACTIONS
        function handleKey(k) {
            AudioController.playClick();
            if (State.victory) return;
            
            // Determine max length
            const isSinLlevadas = State.gameMode === 'SIN_LLEVADAS';
            const maxMinuend = isSinLlevadas ? 1 : 2;
            const maxSubtrahend = isSinLlevadas ? 1 : 2;
            const maxResult = 3; // Keep result generous

            const addChar = (curr, max) => curr.length < max ? curr + k : curr;
            
            if (State.activeInput === 'minuend') State.minuend = addChar(State.minuend, maxMinuend);
            else if (State.activeInput === 'subtrahend') State.subtrahend = addChar(State.subtrahend, maxSubtrahend);
            else if (State.activeInput === 'result') State.result = addChar(State.result, maxResult);

            // Update bombi floor dynamically in Create mode
            if (State.inputMode === 'CREAR' && State.activeInput === 'subtrahend') {
                 const val = parseInt(State.subtrahend);
                 State.bombiFloor = isNaN(val) ? 0 : val;
            }
            
            render();
        }

        function handleDelete() {
            AudioController.playClick();
            if (State.victory) return;
            const del = (s) => s.slice(0, -1);

            if (State.activeInput === 'minuend') State.minuend = del(State.minuend);
            else if (State.activeInput === 'subtrahend') State.subtrahend = del(State.subtrahend);
            else if (State.activeInput === 'result') State.result = del(State.result);

            if (State.inputMode === 'CREAR' && State.activeInput === 'subtrahend') {
                 const val = parseInt(State.subtrahend);
                 State.bombiFloor = isNaN(val) ? 0 : val;
            }

            render();
        }
        
        function handleClearAll() {
            AudioController.playClick();
            if (State.inputMode !== 'CREAR') return;
            State.minuend = '';
            State.subtrahend = '';
            State.result = '';
            State.bombiFloor = 0;
            State.activeInput = 'minuend';
            State.steps = 0;
            render();
        }

        function handleCheck() {
            AudioController.playClick();
            // Create Mode: Transition to Solve Mode
            if (State.inputMode === 'CREAR' && !State.result && State.activeInput !== 'result') {
                const m = parseInt(State.minuend);
                const s = parseInt(State.subtrahend);
                
                if (isNaN(m) || isNaN(s)) {
                    showMessage("¬°Introduce los n√∫meros primero!");
                    AudioController.playError();
                    return;
                }
                if (m <= s) {
                    showMessage("El n√∫mero de arriba debe ser mayor");
                    AudioController.playError();
                    return;
                }
                
                // Validate limits based on mode
                if (State.gameMode === 'SIN_LLEVADAS') {
                    if (m > 9) {
                        showMessage("¬°M√°ximo planta 9!");
                        AudioController.playError();
                        return;
                    }
                } else {
                    if (m > 25) {
                        showMessage("¬°Usa n√∫meros m√°s peque√±os!");
                        AudioController.playError();
                        return;
                    }
                }

                // Lock creation and start solving
                State.steps = 0;
                State.bombiFloor = s;
                State.activeInput = 'result';
                showMessage("¬°Ahora resuelve la resta!");
                render();
                return;
            }

            // Solve Mode: Check Result
            const m = parseInt(State.minuend);
            const s = parseInt(State.subtrahend);
            const r = parseInt(State.result);
            
            if (isNaN(r)) return;

            if (m - s === r) {
                State.victory = true;
                State.bombiFloor = m; // Move to top
                State.message = "¬°Fuego Apagado!";
                State.activeInput = null;
                AudioController.playVictory();
                render();
                startConfetti();
            } else {
                showMessage("¬°Int√©ntalo de nuevo!");
                AudioController.playError();
            }
        }

        function moveBombi(floors = 1) {
            const m = parseInt(State.minuend);
            if (!isNaN(m) && State.bombiFloor < m) {
                const target = Math.min(m, State.bombiFloor + floors);
                const moved = target - State.bombiFloor;
                if (moved > 0) {
                    State.bombiFloor = target;
                    State.steps += moved;
                    AudioController.playStep();
                    
                    // Check if we are in 'Con Llevadas' mode and Bombi reached the fire
                    if (State.gameMode === 'CON_LLEVADAS' && State.bombiFloor === m) {
                        showMessage("¬°Recuerda! ¬°Te llevas 1!");
                    } else {
                        render();
                    }
                }
            }
        }

        function showMessage(msg) {
            State.message = msg;
            render();
            setTimeout(() => {
                State.message = '';
                render();
            }, 2000);
        }

        function setActive(field) {
            AudioController.playClick();
            if (!State.victory) {
                // In solve mode, prevents editing the problem numbers
                if (State.inputMode === 'RESOLVER' && (field === 'minuend' || field === 'subtrahend')) return;
                // In create mode activeInput is already 'result' means we are solving phase
                if (State.inputMode === 'CREAR' && State.activeInput === 'result' && (field === 'minuend' || field === 'subtrahend')) return;

                State.activeInput = field;
                render();
            }
        }

        // DRAG LOGIC
        let dragStartY = 0;
        let dragStartFloor = 0;
        let dragCurrentY = 0;
        const FLOOR_HEIGHT_PX = 40; // Approximate height of a floor rendered in pixels

        function startDrag(e) {
            if (State.victory) return;
            const evt = e.touches ? e.touches[0] : e;
            dragStartY = evt.clientY;
            dragCurrentY = evt.clientY;
            dragStartFloor = State.bombiFloor;
            State.isDragging = true;
            
            // Attach global listeners
            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('mouseup', handleDragEnd);
            document.addEventListener('touchmove', handleDragMove, { passive: false });
            document.addEventListener('touchend', handleDragEnd);
        }

        function handleDragMove(e) {
            if (!State.isDragging) return;
            e.preventDefault(); // Prevent scrolling
            const evt = e.touches ? e.touches[0] : e;
            dragCurrentY = evt.clientY;
            
            // Calculate visual offset if we were to manipulate DOM directly (optional)
            // For now, we update state only on end to keep simple, OR we could do live update
            // Let's try to move the bombi element visually via transform if possible
            const bombiEl = document.getElementById('bombi-avatar');
            if (bombiEl) {
                const deltaY = dragCurrentY - dragStartY;
                bombiEl.style.transform = `translateY(${deltaY}px) scale(1.2)`;
            }
        }

        function handleDragEnd(e) {
            if (!State.isDragging) return;
            State.isDragging = false;
            
            document.removeEventListener('mousemove', handleDragMove);
            document.removeEventListener('mouseup', handleDragEnd);
            document.removeEventListener('touchmove', handleDragMove);
            document.removeEventListener('touchend', handleDragEnd);

            const deltaY = dragStartY - dragCurrentY; // Up is positive delta in screen coords (Y decreases up)
            
            // Threshold to move 1 floor approx 40px
            // Allow moving multiple floors
            if (deltaY > 20) {
                const floorsToMove = Math.round(deltaY / 40);
                if (floorsToMove > 0) {
                    moveBombi(floorsToMove);
                } else {
                    render(); // Reset position
                }
            } else {
                render(); // Reset position
            }
        }

        // RENDER ENGINE
        function render() {
            const root = document.getElementById('app');
            if (State.screen === 'MENU') {
                root.innerHTML = renderMenu();
            } else {
                root.innerHTML = renderGame();
            }
        }

        function renderMenu() {
            return `
                <div class="flex flex-col items-center justify-center h-full w-full p-4 overflow-y-auto">
                    <div class="text-center mb-8">
                        <div class="text-8xl mb-2 animate-bounce-slow inline-block">üë®‚Äçüöí</div>
                        <h1 class="text-5xl md:text-6xl font-bold text-white drop-shadow-lg mb-2 tracking-wide">Operaci√≥n Rescate</h1>
                        <p class="text-white/90 text-2xl font-medium">Ayuda a Bombi a apagar el fuego</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-5xl px-4">
                        ${renderMenuCard('Sin Llevadas', 'green', 'üòÉ', 'SIN_LLEVADAS')}
                        ${renderMenuCard('Con Llevadas', 'orange', 'üòé', 'CON_LLEVADAS')}
                    </div>
                    <div class="mt-8 text-white/50 text-sm font-bold cursor-pointer" onclick="AudioController.init(); alert('Audio activado')">üîà Activar Audio</div>
                </div>
            `;
        }

        function renderMenuCard(title, color, emoji, mode) {
            return `
                <div class="bg-white/95 p-8 rounded-[2rem] shadow-2xl flex flex-col gap-6 transform transition-transform active:scale-95">
                    <div class="text-center text-4xl font-bold text-${color}-600">${title}</div>
                    <div class="flex-1 flex items-center justify-center py-2 text-7xl">${emoji}</div>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="initGame('${mode}', 'CREAR')" class="bg-${color}-100 hover:bg-${color}-200 text-${color}-800 py-5 rounded-2xl text-2xl font-bold shadow-md border-4 border-${color}-200 hover:border-${color}-300 active:scale-95 transition-all">Inventar</button>
                        <button onclick="initGame('${mode}', 'RESOLVER')" class="bg-${color}-500 hover:bg-${color}-600 text-white py-5 rounded-2xl text-2xl font-bold shadow-lg border-b-8 border-${color}-700 active:border-b-0 active:translate-y-2 transition-all">Resolver</button>
                    </div>
                </div>
            `;
        }

        function renderGame() {
            const isSinLlevadas = State.gameMode === 'SIN_LLEVADAS';
            
            return `
                <div class="flex h-full w-full relative">
                    <!-- LEFT SIDE: INTERFACE -->
                    <div class="flex-1 flex flex-col z-10 relative bg-gradient-to-b from-white/95 to-white/80 backdrop-blur-sm">
                        <!-- Header -->
                        <div class="flex justify-between items-center p-3 bg-white/50 shadow-sm">
                            <button onclick="State.screen='MENU'; render(); AudioController.playClick()" class="p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 shadow-sm active:scale-90 transition-all" title="Volver al inicio">
                                ${Icons.Home}
                            </button>
                            <div class="text-blue-600 font-bold text-xl uppercase tracking-wider hidden md:block bg-blue-50 px-4 py-1 rounded-full border border-blue-100">
                                ${isSinLlevadas ? 'Modo F√°cil' : 'Modo Experto'}
                            </div>
                            <button onclick="initGame('${State.gameMode}', '${State.inputMode}')" class="p-3 rounded-full bg-blue-50 hover:bg-blue-100 text-blue-500 shadow-sm active:scale-90 transition-all">
                                ${Icons.Refresh}
                            </button>
                        </div>

                        <!-- Message Area -->
                        <div class="h-14 flex items-center justify-center my-1 px-4">
                            ${State.message ? `
                                <div class="bg-yellow-400 text-yellow-900 px-6 py-2 rounded-2xl font-bold text-lg animate-bounce shadow-lg border-4 border-white ring-2 ring-yellow-200">
                                    ${State.message}
                                </div>
                            ` : ''}
                        </div>

                        <!-- Board & Keypad Container -->
                        <div class="flex-1 flex flex-col items-center justify-start md:justify-center overflow-y-auto pb-4">
                             ${renderBoard()}
                             <div class="mt-4">
                                ${renderKeypad()}
                             </div>
                        </div>
                    </div>

                    <!-- RIGHT SIDE: BUILDING VISUALIZATION -->
                    <div class="w-[40%] md:w-[45%] h-full bg-sky-300 border-l-8 border-sky-400/50 relative shadow-inner flex flex-col overflow-hidden">
                        <!-- Steps Counter -->
                        <div class="absolute top-4 left-0 right-0 z-30 flex justify-center pointer-events-none">
                            <div class="bg-white/90 rounded-2xl px-6 py-2 shadow-xl text-center border-4 border-white/50">
                                <p class="text-gray-500 text-[10px] font-black tracking-widest uppercase mb-1">PASOS DE BOMBI</p>
                                <div class="text-4xl font-black text-blue-500 leading-none">${State.steps}</div>
                            </div>
                        </div>

                        ${renderBuilding()}
                    </div>
                    
                    ${State.victory ? '<div id="confetti" class="absolute inset-0 pointer-events-none z-50"></div>' : ''}
                </div>
            `;
        }

        function renderBoard() {
            const isActive = (f) => State.activeInput === f ? 'bg-blue-50 ring-4 ring-blue-300 text-blue-800 border-blue-400' : 'border-transparent hover:bg-gray-50';
            const isCreateMode = State.inputMode === 'CREAR';
            const isSetupPhase = isCreateMode && State.activeInput !== 'result' && !State.victory;

            return `
                <div class="bg-white p-6 md:p-8 rounded-[2.5rem] shadow-2xl border-[6px] border-blue-100 w-full max-w-[400px] mx-4">
                    <div class="flex flex-col items-end text-6xl md:text-7xl font-mono font-bold text-gray-700 select-none">
                        
                        <!-- Minuend -->
                        <div onclick="setActive('minuend')" 
                             class="px-4 py-2 rounded-xl min-w-[120px] text-right mb-1 cursor-pointer transition-all border-2 ${isActive('minuend')} ${!State.minuend && isSetupPhase ? 'border-dashed border-gray-300 bg-gray-50' : ''}">
                             ${State.minuend || (isSetupPhase && State.activeInput !== 'minuend' ? '<span class="text-gray-300 text-5xl">?</span>' : (State.minuend === '' ? '' : State.minuend))}
                        </div>
                        
                        <div class="flex items-center justify-between w-full mb-1">
                            <span class="text-gray-300 text-7xl ml-2">-</span>
                            <!-- Subtrahend -->
                            <div onclick="setActive('subtrahend')" 
                                 class="px-4 py-2 rounded-xl min-w-[120px] text-right cursor-pointer transition-all border-2 ${isActive('subtrahend')} ${!State.subtrahend && isSetupPhase ? 'border-dashed border-gray-300 bg-gray-50' : ''}">
                                 ${State.subtrahend || (isSetupPhase && State.activeInput !== 'subtrahend' ? '<span class="text-gray-300 text-5xl">?</span>' : (State.subtrahend === '' ? '' : State.subtrahend))}
                            </div>
                        </div>

                        <div class="w-full h-2 bg-gray-200 rounded-full mb-4"></div>

                        <!-- Result -->
                        <div onclick="setActive('result')" 
                             class="w-full text-right px-6 py-3 rounded-2xl text-blue-600 min-h-[80px] cursor-pointer transition-all border-2 ${State.activeInput === 'result' ? 'bg-blue-50 ring-4 ring-blue-200 border-blue-300 shadow-inner' : 'bg-gray-50 border-gray-100'}">
                             ${State.result || '<span class="text-blue-200 opacity-50">?</span>'}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderKeypad() {
            const keys = [7,8,9,4,5,6,1,2,3,0];
            const isCreateMode = State.inputMode === 'CREAR';
            
            return `
                <div class="relative max-w-[320px]">
                    ${isCreateMode ? `
                        <button onclick="handleClearAll()" class="absolute -top-10 right-0 bg-white/80 hover:bg-red-50 text-gray-500 hover:text-red-500 px-3 py-1 rounded-lg text-xs font-bold shadow-sm border border-gray-200 flex items-center gap-1 transition-colors">
                           ${Icons.Trash} Borrar todo
                        </button>
                    ` : ''}
                    <div class="grid grid-cols-3 gap-3 p-4 bg-gray-100 rounded-[2rem] shadow-inner">
                        ${keys.map(k => `
                            <button onclick="handleKey('${k}')" class="h-16 text-3xl font-bold bg-white rounded-xl shadow-[0_4px_0_0_rgba(0,0,0,0.1)] border-2 border-b-4 border-gray-200 active:border-b-2 active:translate-y-[2px] active:shadow-none text-gray-600 transition-all ${k===0 ? 'col-span-1' : ''}">${k}</button>
                        `).join('')}
                        
                        <button onclick="handleDelete()" class="h-16 flex items-center justify-center bg-red-50 text-red-500 rounded-xl shadow-[0_4px_0_0_rgba(239,68,68,0.2)] border-2 border-b-4 border-red-100 active:border-b-2 active:translate-y-[2px] active:shadow-none transition-all group">
                            ${Icons.Delete}
                        </button>
                        
                        <button onclick="handleCheck()" class="h-16 flex items-center justify-center bg-green-500 text-white rounded-xl shadow-[0_4px_0_0_rgba(21,128,61,0.3)] border-2 border-b-4 border-green-600 active:border-b-2 active:translate-y-[2px] active:shadow-none transition-all">
                            ${Icons.Check}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderBuilding() {
            // Visualization Logic
            const fireFloor = parseInt(State.minuend);
            const bombiStart = parseInt(State.subtrahend);
            
            let maxRenderFloor = 9; // Default is 0-9

            if (State.gameMode === 'CON_LLEVADAS') {
                // In Expert mode, adapt height if floors go higher
                if (!isNaN(fireFloor)) maxRenderFloor = Math.max(maxRenderFloor, fireFloor);
                if (!isNaN(bombiStart)) maxRenderFloor = Math.max(maxRenderFloor, bombiStart);
                maxRenderFloor += 2; // Add headroom
            }
            // In SIN_LLEVADAS, it stays fixed at 9 (0-9 floors) as requested

            // Generate floors HTML
            let floorsHtml = '';
            for (let i = maxRenderFloor; i >= 0; i--) {
                const isGround = i === 0;
                const isFire = i === fireFloor && !State.victory && !isNaN(fireFloor);
                const isBombi = i === State.bombiFloor;
                
                floorsHtml += `
                    <div class="h-9 w-44 md:w-56 border-x-[6px] border-gray-700 bg-yellow-100 relative flex items-center justify-center shrink-0 ${isGround ? 'border-b-[6px] border-gray-700' : 'border-b-2 border-gray-300'} mx-auto shadow-[inset_0_0_10px_rgba(0,0,0,0.05)]">
                        <!-- Floor Number -->
                        <span class="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] text-gray-400 font-black font-mono select-none">${i}</span>
                        
                        ${isGround ? 
                            `<div class="w-14 h-full mt-3 bg-orange-900 rounded-t-md border-x-2 border-t-2 border-orange-950 shadow-inner"></div>` : 
                            `<div class="flex space-x-4 opacity-50">
                                <div class="w-5 h-6 bg-sky-200 border-2 border-sky-300 rounded-sm"></div>
                                <div class="w-5 h-6 bg-sky-200 border-2 border-sky-300 rounded-sm"></div>
                             </div>`
                        }

                        ${isFire ? `<div class="absolute inset-0 flex items-center justify-center z-20 animate-pulse -translate-y-2 filter drop-shadow-lg scale-125">${Icons.Flame}</div>` : ''}

                        ${isBombi ? `
                            <div 
                                id="bombi-avatar"
                                onmousedown="startDrag(event)" 
                                ontouchstart="startDrag(event)"
                                class="absolute inset-0 flex items-center justify-center z-30 transition-all duration-75 ease-out cursor-grab active:cursor-grabbing">
                                <div class="text-3xl filter drop-shadow-xl select-none -translate-y-1 transform transition-transform active:scale-125">üë®‚Äçüöí</div>
                                ${!State.victory && State.bombiFloor < fireFloor ? `
                                    <button 
                                        onmousedown="event.stopPropagation()"
                                        ontouchstart="event.stopPropagation()"
                                        onclick="event.stopPropagation(); moveBombi()" 
                                        class="absolute -right-14 md:-right-16 top-1/2 -translate-y-1/2 bg-white text-blue-600 w-10 h-10 flex items-center justify-center rounded-full shadow-[0_0_15px_rgba(37,99,235,0.6)] animate-bounce border-2 border-blue-200 hover:bg-blue-50 active:scale-90 transition-transform ring-2 ring-blue-100 z-50">
                                        ${Icons.ArrowUp}
                                    </button>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            return `
                <div class="h-full w-full overflow-y-auto overflow-x-hidden flex flex-col pt-20 no-scrollbar relative bg-sky-300">
                     <!-- Sky Elements -->
                     <div class="absolute top-10 left-4 opacity-80 scale-150 pointer-events-none">${Icons.Cloud}</div>
                     <div class="absolute top-24 right-[-20px] opacity-60 scale-[2] pointer-events-none">${Icons.Cloud}</div>
                     
                     <!-- Victory Message Overlay -->
                     ${State.victory ? `
                         <div class="absolute top-1/4 left-0 right-0 z-50 flex justify-center pointer-events-none animate-bounce">
                             <div class="bg-blue-600 text-white text-2xl font-black py-4 px-8 rounded-full shadow-2xl border-4 border-white">
                                 ¬°APAGADO!
                             </div>
                         </div>
                     ` : ''}

                     <div class="mt-auto w-full pb-0 flex flex-col items-center">
                        <!-- Roof -->
                        <div class="w-48 md:w-60 h-4 bg-gray-600 rounded-t-xl mx-auto z-10 relative -mb-[1px]"></div>
                        ${floorsHtml}
                        <!-- Ground -->
                        <div class="w-full h-12 bg-grass-green border-t-[6px] border-green-700 relative z-30"></div>
                     </div>
                </div>
            `;
        }

        function startConfetti() {
            const container = document.getElementById('confetti');
            if(!container) return;
            container.innerHTML = ''; // Clear previous
            const colors = ['#ef4444', '#3b82f6', '#eab308', '#22c55e', '#f472b6'];
            
            for(let i=0; i<60; i++) {
                const p = document.createElement('div');
                const size = Math.random() * 8 + 5 + 'px';
                p.className = 'absolute rounded-sm';
                p.style.width = size;
                p.style.height = size;
                p.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
                p.style.left = Math.random()*100 + '%';
                p.style.top = -20 + 'px';
                p.style.opacity = Math.random() + 0.5;
                p.style.transform = `rotate(${Math.random()*360}deg)`;
                
                // Inline animation
                p.animate([
                    { transform: `translateY(0) rotate(0deg)`, opacity: 1 },
                    { transform: `translateY(110vh) rotate(${720 + Math.random()*720}deg)`, opacity: 0 }
                ], {
                    duration: 2000 + Math.random() * 3000,
                    delay: Math.random() * 1000,
                    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)',
                    fill: 'forwards'
                });
                
                container.appendChild(p);
            }
        }

        // BOOTSTRAP
        render();

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>